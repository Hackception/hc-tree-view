<link rel="import" href="../polymer/polymer.html">

<script>
  /* global hc */
  // Ensure namespace exists
  window.hc = window.hc || {};

  /**
   * Use `hc.TreeNodeBehavior` to implement a tree node that supports tristate selection, reflecting changes to selected
   *  and state back to one another, needed to support iron-list showing selected items while maintaining tristate.
   *
   * @polymerBehavior hc.TreeNodeBehavior
   */
  hc.TreeNodeBehavior = {
    properties: {
      /* Allows toggling between indeterminate nodes being considered selected or not selected */
      indeterminateIsSelected: {
        type: Boolean,
        value: false
      },
      /* False when state is off, otherwise it's true */
      selected: {
        type: Boolean,
        value: false,
        notify: true
      },
      /* Holds the tri-state value */
      state: {
        type: String,
        value: 'off'
      }
    },
    observers: [
      '_selectedChanged(selected, indeterminateIsSelected)',
      '_stateChanged(state, indeterminateIsSelected, item.hasChildren)'
    ],
    ready() {
      // Overload the default tap functionality to prevent user clicks from setting indeterminate state.
      this.$.checkbox._regularTap = () => {
        if (this.state == null)
          this.state = 'on';
        else if (this.state == 'on')
          this.state = 'off';
        else if (this.state == 'off')
          this.state = 'on';
      };
    },
    /**
     * Ensures that changes to selected are properly reflected in the state attribute which controls how the checkbox
     *  looks, also takes indeterminate state into account for selection.
     *
     * @fires hc-nested-list-behavior#item-selected-changed
     * @param {Boolean} selected
     * @param {Boolean} indeterminateIsSelected
     */
    _selectedChanged(selected, indeterminateIsSelected) {
      const state = (this.state === null && !(selected ^ indeterminateIsSelected)) ? null :
        selected ? 'on' : 'off';

      // Ensure a change was made to avoid cyclical updates
      if (state !== this.state) this.state = state;
      // Notify the list that selection was changed
      this.fire('item-selected-changed', {item: this.item, selected});
    },
    /**
     * Ensures that changes to state are properly reflectd in the selected attribute which is used to calculate the
     *  selected items for the tree.
     *
     * @fires hc-nested-list-behavior#item-state-changed
     * @param {String} state
     * @param {Boolean} indeterminateIsSelected
     * @param {Boolean} hasChildren
     */
    _stateChanged(state, indeterminateIsSelected, hasChildren) {
      // off => null => on, if there's no children then skip null
      if (!state && !hasChildren)
        this.state = state = 'on'; // Update local and element versions

      const selected = state === 'on' ? true :
        state === 'off' ? false :
        indeterminateIsSelected;

      // Ensure a change was made to avoid cyclical updates
      if (selected !== this.selected) this.selected = selected;
      // Notify the list that state was changed
      this.fire('item-state-changed', {item: this.item, state});
    }
  };
</script>
